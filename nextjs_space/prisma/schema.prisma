generator client {
    provider = "prisma-client-js"
    binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

enum FahrzeugStatus {
  VERFUEGBAR
  IN_WARTUNG
  AUSSER_BETRIEB
  NUR_NOTFALL
}

enum BuchungStatus {
  GEPLANT
  LAUFEND
  ABGESCHLOSSEN
  STORNIERT
}

enum BuchungsArt {
  NORMALFAHRT
}

enum ZahlungStatus {
  AUSSTEHEND
  BESTAETIGT
}

enum FahrtStatus {
  GESTARTET
  ABGESCHLOSSEN
}

enum ZahlungsArt {
  BAR
  TANKEN
  PFLEGE
  WARTUNG
  REPARATUR
}

enum WartungsIntervallTyp {
  KILOMETER      // z.B. alle 10.000 km
  WOCHEN         // z.B. alle 6 Wochen
  MONATE         // z.B. alle 3 Monate
  JAEHRLICH      // z.B. jährlich im November
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String
  role          UserRole  @default(USER)
  isActive      Boolean   @default(true)
  deactivatedAt DateTime?
  emailVerified DateTime?
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  accounts      Account[]
  sessions      Session[]
  fahrzeugeAlsHalter Fahrzeug[] @relation("FahrzeugHalter")
  buchungen     Buchung[]
  fahrten       Fahrt[]
  zahlungenAlsFahrer Zahlung[] @relation("ZahlungFahrer")
  erledigteWartungsTasks WartungsTask[] @relation("TaskErledigtVon")
  zugewieseneWartungsTasks WartungsTask[] @relation("TaskZugewiesenAn")
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Fahrzeug {
  id                      String         @id @default(cuid())
  name                    String
  foto                    String?
  kilometerstand          Int
  kilometerpauschale      Float
  treibstoffKosten        Float          @default(0)
  fixkosten               Float          @default(0)
  wartungsReparaturKosten Float          @default(0)
  halterId                String
  schluesselablageort     String
  status                  FahrzeugStatus @default(VERFUEGBAR)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt

  // Lebenszyklus-Felder (nur Admin editierbar)
  baujahr                 Int?           // z.B. 2018
  restwert                Float?         // Aktueller Restwert in Euro
  erwarteteKmEndOfLife    Int?           // Erwartete Gesamtkilometer bei End of Life
  erwarteteJahreEndOfLife Int?           // Erwartetes Alter bei End of Life
  geschaetzteKmProJahr    Int?           // Geschätzte Kilometer pro Jahr

  // Steckbrief-Felder
  versicherungsart        String?        // z.B. Haftpflicht, Teilkasko, Vollkasko
  kraftstoffart           String?        // z.B. Benzin, Diesel, Elektro, Hybrid
  aktuelleReifen          String?        // z.B. Sommerreifen, Winterreifen, Allwetter
  naechsterOelwechsel     String?        // z.B. "bei 120.000 km" oder Datum
  reinigungszyklus        String?        // z.B. "monatlich", "alle 2 Wochen"
  motoroelTyp             String?        // z.B. "5W-30"
  kuehlerFrostschutzTyp   String?        // z.B. "G12+"
  anzahlSitze             Int?           // Anzahl der Sitzplätze
  anhaengerkupplung       Boolean        @default(false)
  kindersitz              Boolean        @default(false)
  defekte                 String?        // Bekannte Defekte
  naechsterTuev           String?        // z.B. "03/2025"
  macken                  String?        // Bekannte Macken
  sonstigeHinweise        String?        // Freies Textfeld für weitere Hinweise

  halter              User                @relation("FahrzeugHalter", fields: [halterId], references: [id], onDelete: Cascade)
  buchungen           Buchung[]
  fahrten             Fahrt[]
  zahlungen           Zahlung[]
  wartungsIntervalle  WartungsIntervall[]
  wartungsTasks       WartungsTask[]
  kilometerpauschaleHistorie KilometerpauschaleHistorie[]
}

model Buchung {
  id          String        @id @default(cuid())
  fahrzeugId  String
  userId      String
  startZeit   DateTime
  endZeit     DateTime
  status      BuchungStatus @default(GEPLANT)
  buchungsart BuchungsArt   @default(NORMALFAHRT)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  fahrzeug Fahrzeug @relation(fields: [fahrzeugId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  fahrt    Fahrt?
}

model Fahrt {
  id                String      @id @default(cuid())
  buchungId         String      @unique
  fahrzeugId        String
  fahrerId          String
  startKilometer    Int
  endKilometer      Int?
  gefahreneKm       Int?
  kosten            Float?
  status            FahrtStatus @default(GESTARTET)
  bemerkungen       String?
  kilometerKonflikt Boolean     @default(false)
  konfliktGeloest   Boolean     @default(false)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  buchung  Buchung  @relation(fields: [buchungId], references: [id], onDelete: Cascade)
  fahrzeug Fahrzeug @relation(fields: [fahrzeugId], references: [id], onDelete: Cascade)
  fahrer   User     @relation(fields: [fahrerId], references: [id], onDelete: Cascade)
}

model Zahlung {
  id                    String         @id @default(cuid())
  fahrerId              String
  fahrzeugId            String
  betrag                Float
  zahlungsart           ZahlungsArt    @default(BAR)
  beleg                 String?
  bestaetigung_fahrer   Boolean        @default(false)
  bestaetigung_halter   Boolean        @default(false)
  status                ZahlungStatus  @default(AUSSTEHEND)
  beschreibung          String?
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt

  fahrer   User     @relation("ZahlungFahrer", fields: [fahrerId], references: [id], onDelete: Cascade)
  fahrzeug Fahrzeug @relation(fields: [fahrzeugId], references: [id], onDelete: Cascade)
}

model WartungsIntervall {
  id              String                @id @default(cuid())
  fahrzeugId      String
  name            String                // z.B. "Reinigung", "Ölwechsel", "Frostschutz prüfen"
  beschreibung    String?               // Optionale Details
  intervallTyp    WartungsIntervallTyp  // KILOMETER, WOCHEN, MONATE, JAEHRLICH
  intervallWert   Int                   // z.B. 10000 (km), 6 (Wochen), 3 (Monate)
  monatImJahr     Int?                  // Für JAEHRLICH: 1-12 (Januar-Dezember)
  aktiv           Boolean               @default(true)
  createdAt       DateTime              @default(now())
  updatedAt       DateTime              @updatedAt

  fahrzeug        Fahrzeug              @relation(fields: [fahrzeugId], references: [id], onDelete: Cascade)
  tasks           WartungsTask[]
}

model WartungsTask {
  id                  String              @id @default(cuid())
  fahrzeugId          String
  wartungsIntervallId String?
  titel               String              // z.B. "Reinigung fällig"
  beschreibung        String?             // Details zur Aufgabe
  faelligAm           DateTime?           // Wann ist die Aufgabe fällig
  faelligBeiKm        Int?                // Bei welchem Kilometerstand fällig
  erledigt            Boolean             @default(false)
  erledigtAm          DateTime?
  erledigtVonId       String?
  zugewiesenAnId      String?             // Wer hat die Aufgabe übernommen
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt

  fahrzeug            Fahrzeug            @relation(fields: [fahrzeugId], references: [id], onDelete: Cascade)
  wartungsIntervall   WartungsIntervall?  @relation(fields: [wartungsIntervallId], references: [id], onDelete: SetNull)
  erledigtVon         User?               @relation("TaskErledigtVon", fields: [erledigtVonId], references: [id], onDelete: SetNull)
  zugewiesenAn        User?               @relation("TaskZugewiesenAn", fields: [zugewiesenAnId], references: [id], onDelete: SetNull)
}

// Historie der Kilometerpauschalen - Änderungen nur zum Monatsersten möglich
model KilometerpauschaleHistorie {
  id            String    @id @default(cuid())
  fahrzeugId    String
  pauschale     Float     // Kilometerpauschale in €/km
  gueltigAb     DateTime  // Immer der 1. eines Monats
  createdAt     DateTime  @default(now())

  fahrzeug      Fahrzeug  @relation(fields: [fahrzeugId], references: [id], onDelete: Cascade)

  @@index([fahrzeugId, gueltigAb])
}
